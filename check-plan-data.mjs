import { drizzle } from 'drizzle-orm/node-postgres';
import pg from 'pg';
import * as schema from './shared/schema.ts';
import { eq, desc } from 'drizzle-orm';

const { Pool } = pg;

// Load env
import { config } from 'dotenv';
import { resolve } from 'path';
config({ path: resolve('./server/.env') });

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const db = drizzle(pool, { schema });

async function checkPlanData() {
  console.log('üîç Checking latest nutrition plan in database...\n');
  
  const plans = await db
    .select()
    .from(schema.optimizePlans)
    .where(eq(schema.optimizePlans.planType, 'nutrition'))
    .orderBy(desc(schema.optimizePlans.createdAt))
    .limit(1);
  
  if (plans.length === 0) {
    console.log('‚ùå No nutrition plans found in database');
    process.exit(0);
  }
  
  const plan = plans[0];
  console.log(`üìã Plan ID: ${plan.id}`);
  console.log(`üìÖ Created: ${plan.createdAt}`);
  console.log(`üë§ User ID: ${plan.userId}`);
  console.log(`‚úÖ Is Active: ${plan.isActive}\n`);
  
  const content = plan.content;
  
  console.log('üìä Plan Content Structure:');
  console.log(`   - Has weekPlan: ${!!content.weekPlan}`);
  console.log(`   - weekPlan is array: ${Array.isArray(content.weekPlan)}`);
  console.log(`   - weekPlan length: ${content.weekPlan?.length || 0}`);
  
  if (content.weekPlan && Array.isArray(content.weekPlan)) {
    console.log(`\nüìÖ Days in weekPlan:`);
    content.weekPlan.forEach((day, idx) => {
      const mealsCount = day.meals?.length || 0;
      const firstMeal = day.meals?.[0];
      console.log(`   ${idx + 1}. ${day.dayName || day.day} - ${mealsCount} meals`);
      if (firstMeal) {
        console.log(`      First meal: ${firstMeal.name} (${firstMeal.mealType})`);
      }
      if (mealsCount === 0 || firstMeal?.name === 'Meal data unavailable') {
        console.log(`      ‚ö†Ô∏è  This is a PLACEHOLDER day (not generated by AI)`);
      }
    });
  }
  
  console.log(`\nüîß Auto-heal metadata:`);
  console.log(`   - missingDays: ${content.autoHealMeta?.missingDays}`);
  
  await pool.end();
}

checkPlanData().catch(console.error);
